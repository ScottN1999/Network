# Scalability and HA


## Scalability

## Vertical Scaling
- Resizing EC2 instance
- t3.large â†’ t3.xlarge
- Each resize requires a reboot - disruption
- Larger instances often carry a $ premium
- There is an upper cap on performance - instance size
- No application modification required
- Works for ALL applications - even monoliths

## Horizontal Scaling
- Adds more instances as load increases
- Load Balancer Between servers and customers
- Distribute load over all servers
- Sessions, sessions, sessions
- Requires application support OR off-host sessions (stateless sessions)
- No disruption when scaling
- Connections can be moved between servers (if stateless sessions without disruption)
- Often less expensive - no large instance premium
- More granular

## HA

High availability refers to ensuring the service continues without fault, this usually can be implemented by spreading EC2s across different AZs - HA does not equate to scalability however horizontal scaling does follow the same principals.

## Application Load Balancer (ALB)

- **Layer 7** load balancer
    - Listens on **HTTP/HTTPS**
- **No other Layer 7 protocols (**SMTP, SSH, Gaming)
    - And **NO TCP/UDP/TLS Listeners**
- L7 content type, cookies, custom headers, user location and app behaviour
- HTTP HTTPS (SSL/TLS) always terminated on the ALB - **no unbroken SSL** (security teams!)
    - **A new connection is made to the application**
- ALBs **MUST** have **SSL** certs if **HTTPS** is used
- ALBs are **slower** than **NLB**. More levels of the networks stack to process
- Health checks **evaluate application health**
    - Layer 7

## ALB Rules

- Rules **direct connections** which arrive at a listener
- Processed in **priority order**
- **Default rule = catchall**
- **Rule Conditions:** host-header, http-header, http-request-method, path-pattern, query-string and source-ip
- **Actions:** forwards, redirects, fixed-response, authenticate-oids & authenticate-cognito

## Network Load Balancer NLB

- Operates layer 4
- Forward TCP & UDP traffic to your instances
- Handle millions of request per second
- Less latency ~ 100MS (vs 400 ms for ALB)

NLB has one static IP per AZ, and supports assigning Elastic IP (helpful for whitelisting specific IP). NLB are used for **extreme performance, TCP or UDP** (Not included in the AWS free tier).

<img width="431" alt="image" src="https://github.com/UpheldSmile/Virtual-Network/assets/49825639/0722e0a2-33f0-4b1e-85b0-5d65fcce7513">

## Target groups for NLB

- EC2s
- Can register IP addresses (must be private and static)
- Application Load Balancer (use case: fixed IP address from NLB, and then can leverage ALB for all HTTP related rules you get from the ALB).
- Health checks support the TCP, HTTP, and HTTPS protocol.

<img width="414" alt="image" src="https://github.com/UpheldSmile/Virtual-Network/assets/49825639/961951dd-c684-4d3c-b1ca-bbca4e6167d3">

## Gateway Load Balancer

Deploy, scale, and manage a fleet of 3rd party network virtual appliances. Use case: firewalls, IDS + IPS, Deep packet inspection systems, payload manipulation

<img width="261" alt="image" src="https://github.com/UpheldSmile/Virtual-Network/assets/49825639/a80c7c08-b862-4daf-bd03-4cf1c8a8ea23">

Operates at Layer 3 (network layer) - IP Packets > combines the following functions:
- Transparent Network Gateway - single entry/exit for all traffic
- Load Balancer - distributes traffic to your virtual appliances

Use the GENEVE protocol on port 6081

## Target groups for GWLB

- EC2 instances
- Ip addresses - must be private

## Sticky Sessions ( Session Affinity )

It is possible to implement stickiness so that the same client is always redirected to the same instance behind a load balancer. This works for CLB, ALP, and NLB.

The 'cookie' used for stickiness has an expiration date you can control (not a requirement for a NLB (WORKS WITHOUT)). Use case: make sure the user doesn't lose his session data > enabling stickiness may bring imalance to the load over the backend EC2 instances.

## Cookies
There is two types:

1. Application-based cookies
   
    - Custom cookies
        - Generated by the target
        - Can include any custom attributes required by the application
        - Cookie name must be specified individually for each target group
        - Don't use AWSALB, AWSALBAPP, or AWSALBTG (reserved for use by the ELB)
    - Application cookies
        - Generated by the load balancer
        - cookie name is AWSALBAPP
          
3. Duration-based cookies
    - Cookie generate by the ELB
    - Cookie name is AWSALB for ALB, ASWSELB for CLB
    - Expiry based by the ELB, Application based is specified by the application itself
  

## Cross-Zone Load Balancing

<img width="419" alt="image" src="https://github.com/UpheldSmile/Virtual-Network/assets/49825639/5783a19d-4863-4dc0-ba79-907b7d9625a1">

Application Load Balancer
- Cross-zone is enabled by default ( can be disabled at the target group level )
- No charges for inter AZ data

NLB and GWLB
- Disabled by default
- You pay $$ for inter AZ data if enabled

CLB
- Disabled by default
- No charges for inter AZ data

## SSL/TLS in ELB
An SSL cert allows traffic between your clients and your ELB  to be encypted in transit (in-flight encryption)

- Secure Sockets Layer, used to encrypt connections
- Transport Layer Security, which is newer
- Nowadays, TLS certs are mainly used, but people still call it SSL

- Public SSL certs are issues by Cert authorities (CA) - E.g. GoDaddy, LetsEncrypt, Comodo, Symantec, GlobalSign, Digicert, ect.

SSL certs have an expiry date (you set) and you must renew.


<img width="365" alt="image" src="https://github.com/UpheldSmile/Virtual-Network/assets/49825639/d8aaa96a-320c-4be7-af39-bb980554108f">

**The process...**
- The ELB uses an X.509 cert (SSL/TLS server cert)
- You can manage certs using ACM ( AWS certificate manager )
- You can create upload your own certs alternatively
- HTTPS listener:
    - You must specify a default cert
    - You can create an optional list of certs to support multiple domains
    - **Clients can use SNI (Server Name Indication) to specify the hostname they reach**
    - Ability to specify a security policy to support older versions of SSL/TLS
 
## SNI - Server Name Indication
Solves the problem of loading **multiple SSL certs onto one web server** (to serve multiple websites)

It's a "newer" protocol, and requires the client to **indicate** the hostname of the target server in the initial SSL handshake

The server will then find the correct cert, or return the default one

Note:
- Only works for the ALB and NLB (newer gen), CloudFront
- Does not work for CLB

<img width="209" alt="image" src="https://github.com/UpheldSmile/Virtual-Network/assets/49825639/5ef5034c-b35e-43bf-8a3a-bda3b8bfa608">

## SSL Certs

- CLB
Support only **one SSL cert**
Must use multiple CLB for multiple hostname with multiple SSL certs

- ALB (V2)
Supports multiple listeners with multiple SSL certs
Uses SNI to make it work

**(Same for NLB)**

## Connection draining

Named differently for ELB
- Connection draining for CLB
- Deregistration Delay for ALB and NLB

Time to complete "in-flight requests" while the instance is de-registering or unhealthy

Stops sending new requests to the EC2 instances which is de-registering

Between 1 to 3600 seconds (default: 300), can be disabled (set value to 0)

Set to a low value if your requests are short, long requests are like downloads or uploads 

<img width="190" alt="image" src="https://github.com/UpheldSmile/Virtual-Network/assets/49825639/5841efc4-282b-4276-af07-8a2739a77eec">

## Autoscaling groups
In real-life, the load on your websites and app can change, in the cloud - you can create and get ride of servers easily, this is where ASGs come in

ASGs goals are to:
- Scale out (Add EC2s) when increase in load
- Scale in (remove EC2s) when decrease in load
- Ensure we have a minimum and max ec2s
- It can automatically register new instances to an ELB
- Recreate and EC2 in case of a previous one is terminated (e.g. Unhealthy)

ASGs are free (you only pay for the EC2s)

<img width="379" alt="image" src="https://github.com/UpheldSmile/Virtual-Network/assets/49825639/74ca9c05-fc09-4dd0-8b99-d69ff22e0c75">


<img width="377" alt="image" src="https://github.com/UpheldSmile/Virtual-Network/assets/49825639/35cad3ca-95aa-4c4c-b498-cb5cc11592ff">

## ASGs Attributes (Older "Launch Configurations)

- A launch template
    - AMI + Instance type
    - EC2 User data
    - EBS Volumes
    - NSG
    - SSH key pair
    - IAM roles for ec2
    - Network + subnet details
    - ELB info
- Min Size, Max size, initial cap
- Scaling policies

ASGs work well with AWS CloudWatch, CloudWatch can make alarms e.g. if an EC2 hits 90% CPU util then the ASG can create a new ec2 and spread the load (scale out).

## Scaling Policies

1. Dynamic Scaling
    - Target tracking scaling
        - Simple to setup
        - Examples: I want the avg ASG CPU to stay around 40%
      - Simple / Step scaling
        - When a CloudWatch alarm is triggered (e.g. CPU > 70%) then add 2 units
        - CloudWatch alarm is triggered (e.g. CPU < 30%) then remove 1
2. Scheduled Scaling
    - Anticipate a scaling based on known usage patterns
    - Example: Increase the min cap to 10 at 5pm on Fridays

3. Predicitve scaling
    - Continously forecast load and schedule scaling ahead
    - <img width="350" alt="image" src="https://github.com/UpheldSmile/Virtual-Network/assets/49825639/3ea4e4f0-610e-4a3b-84f5-749b7f2ce432">

**Good metrics to scale on**
- CPU Util
- RequestCountPerTarget: to make sure the number of requests per ec2 is stable
- Average Network in / out (if your application is network bound e.g. downloads/up)
- Any custom metric (that you push using CloudWatch)

Scaling cooldowns, after a scaling activity happens, you are in the cool down period (default 300s)

During the cooldown period, the ASG will not launch or terminate additional instance, reason > to allow for metrics to stablise)

<img width="176" alt="image" src="https://github.com/UpheldSmile/Virtual-Network/assets/49825639/16521b52-92d3-4f80-89b9-6087b9d50346">

Tips: Use a ready-to-use AMI to reduce config time in order to be serving requests faster and reduce the cooldwon period
