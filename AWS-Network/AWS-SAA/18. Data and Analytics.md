# Amazon Athena

Serverless query service to analyse data stored in S3 using SQL to query the files.

Supports CSV, JSON, ORC, Avro, and Parquet

Pricing $5 per TB of data scanned.

Commonly use with Amazon Quicksight for reporting/dashboards

**Use cases**: Business intelligence / analytics / reporting, analyse and query VPC Flow Logs, ELB Logs, CloudTrail trails, etc.

**Exam tip:** Analyse data in S3 using serverless SQL > Athena

![image](https://github.com/UpheldSmile/Virtual-Network/assets/49825639/0fa4fc99-c9ef-4bfe-ba2a-f9bc0ff60ebe)


## Athena - Performance Improvement

Use **columnar data** for cost-savings (less scan) 
  - Apache Parquet or ORC is recommended
  - Hugh performance improvement
  - Use Glue to convert your data to Paquet or ORC

Compress data for smaller retrievals (gzip, zlip, zstd)

Partition datasets in S3 for easy querying on virtual columns
  - s3://yourBucket/pathToTable
    - /<PARTITION_COLUMN_NAME>=<VALUE>
      - /<PARTITION_COLUMN_NAME>=<VALUE>

etc.

Example: s3://athena-eg/flight/parquet/year=1999/month=1/day=1/

Use larger files ( > 128 MB) to minimise overheard

## Athena - Federated Query

Allows you to run SQL queries across data stored in relational, non relational, object, and custom data sources (AWS or onprem)

Use Data Source Connectors that run on AWS Lambda to run Federated Queries

Store the results back in S3

![image](https://github.com/UpheldSmile/Virtual-Network/assets/49825639/c5301700-ed3e-4ca8-be9e-5a35b8940dd0)


# Redshift

Redshift is based of PostgreSQL, but it's **not used for OLTP**

It's OLAP - online analytical processing (analytics and data  warehousing)

10x better performance than other data warehouses, scales to PBs of data

**Columnar** storage of data (instead of row based) and parallel query engine

Pay as you go based on the instances provisioned.

Has a SQL interface for performing the queries, BI tools such as Amazon Quicksight or Tableau integrate with it.

**vs Athena:** Faster qeuries/joins/aggregations thanks to indexes.

## Redshift Cluster

- **Leader node:** For query planning, results aggregation
- **Compute node:** For performing the queries, send results to leader

You provision the node size in advanced, you can use Reserved Instances for cost savings.

![image](https://github.com/UpheldSmile/Virtual-Network/assets/49825639/b800c53a-8dba-468d-8bba-6912a7ca3988)

## Snapshots and DR

Redshift has "Multi-AZ" mode for some clusters

Snapshots are point-in-time backups of a cluster > stored internally in S3.

Snapshots are incremental.

You can restore a snapshot into a new **cluster**

- Automated: every 8 hours, every 5gb, or on a schedule. Set retention
- Manual: Snapshot is retained until you delete it

You can configure Redshift to automatically copy snapshots (automated or manual) of a cluster to another AWS Region

![image](https://github.com/UpheldSmile/Virtual-Network/assets/49825639/dfb5d96a-9b8d-4151-a028-5b01885a3815)

## Loading data into Redshift

![image](https://github.com/UpheldSmile/Virtual-Network/assets/49825639/7118864a-5c3a-436c-a022-3799ff3e5726)

## Redshift Spectrum

Query data that is already in S3 without loading it.

**Must have a Redshift cluster available to start the query**

The query is then submitted to thousands of Redshift Spectrum nodes.

![image](https://github.com/UpheldSmile/Virtual-Network/assets/49825639/653db509-8df0-4fc0-85ef-5871edf16f5a)

# Amazon OpenSearch

Used to be called Amazon ElasticSearch, in DynamoDB, queries only exist by primary key or indexes ... **Wtih OpenSearch, you can search any field, even partially matches**

It's common to use OpenSearch as a complement to another database.

Two modes: **managed cluster or severless cluster.**

Does not natively SQL (can be enabled by a plugin)

Ingestion from Kinesis Data Firehose, AWS IoT, and CloudWatch Logs

Security through Cognito and IAM, KMS decryption, TLS

Comes with OpenSearch Dashboards (visualization)

